#!/usr/bin/env perl
use Socket;
use IO::Handle;

($port, $rootdir, $index, $cgidir, $maxclients) = Sioux::chargerLaConf();

socket (SERVEUR, PF_INET, SOCK_STREAM, getprotobyname('tcp'));
setsockopt (SERVEUR, SOL_SOCKET, SO_REUSEADDR, 1);
$mon_adresse = sockaddr_in ("$port", INADDR_ANY);
bind(SERVEUR, $mon_adresse) || die ("bind");
listen (SERVEUR, SOMAXCONN) || die ("listen");

while (accept (CLIENT, SERVEUR) || die ("accept")) {
  $pid = fork;
  if ($pid == 0) {
    $req=<CLIENT>;
    chomp($req);
    ($methode,$ressource,$protocole)=split(/ /, $req);
    chop($protocole);
    print CLIENT "error GET\n" unless $methode eq "GET";
    print CLIENT "error HTTP\n" unless $protocole eq "HTTP/1.0";

    $fichier = $rootdir.$ressource;
    if ($ressource =~ /\/$/){
      $entete = "HTTP/1.0 200 OK\n Content-Type:html\n\n";
      print CLIENT $entete;
      if(-e $rootdir."/".$index){
	  $pagedepart = $rootdir."/".$index;
	  open(OUT,$pagedepart);
	  while(<OUT>){
	      print CLIENT $_;
	  }
	  close(OUT);
      }
      else{
	  $pagedepart = $fichier;
	  open(DOSSIER,$pagedepart);
	  @dos = readdir DOSSIER;
	  @dos = sort @dos;
	  foreach(@dos){
	      unless ($_ eq "." || $_ eq ".."){
		  print CLIENT '<a href="'.$_.'">'.$_.'</a><br />';
	      }
	  }
      }
    }
    else {
      if ($ressource =~ /\.cgi/){
        @ress = split(/%20/, $ressource);
        $scriptCgi = "";
        foreach(@ress){
          $scriptCgi = $scriptCgi." ".$_;
        }
        $scriptCgi=reverse($scriptCgi);
        chop($scriptCgi);
        $scriptCgi=reverse($scriptCgi);

        open(SCRIPT,"perl $cgidir$scriptCgi |");
        while(<SCRIPT>){
          print CLIENT $_;
        }
        close(SCRIPT);
      }
      else{
        if (-d $fichier) {
          $entete = "HTTP/1.0 200 OK\n Content-Type:html\n\n";
          print CLIENT $entete;
          opendir(DOSSIER,$fichier);
          @dos = readdir DOSSIER;
          @dos = sort @dos;
          foreach(@dos){
            unless ($_ eq "."){
              print CLIENT '<a href="'.$_.'">'.$_.'</a><br />';
            }
          }
          close(DOSSIER);
        }
        else {
          if (-e $fichier) {
            $ext = $fichier;
            $ext =~ s/(.*)\.(.*)$/$2/;
            if($ext eq "txt"){
              $entete = "HTTP/1.0 200 OK\n Content-Type:text\n\n"
            }
            else {
              if($ext eq "jpeg"){
                $entete = "HTTP/1.0 200 OK\n Content-Type:image/jpeg\n\n";
              }
              else {
                if($ext eq "html"){
                  $entete = "HTTP/1.0 200 OK\n Content-Type:html\n\n";
                }
              }
            }
            print CLIENT $entete;
            open(OUT,$fichier);
            while(<OUT>){
              print CLIENT $_;
            }
          }
        }
      }
    }
    exit;

  } elsif ($pid != 0) {
    Sioux::enregistrerFils($pid);
    Sioux::tuerLesFilsZombi($pid);
  }
  close (CLIENT);
}
close (SERVEUR);
